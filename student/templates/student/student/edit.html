{% extends 'admin_dashboard/layout.html' %}
{% block 'main' %}
{% load static %}

<!-- Toast Notification Container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999">
    <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 grid-margin">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">EDIT STUDENT - {{ student|upper }}</h4>
                {% if form.errors %}
                <h5 class="text-danger">{{form.errors}}</h5>
                {% endif %}
                <form action="" class="row g-3 needs-validation" novalidate method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="col-12 grid-margin">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="card-title"> PARENT INFORMATION </p>
                                        <div class="row" id="current_parent_display">
                                            <div class="col-md-4">
                                                <img id="parent_image_display"
                                                     {% if student_parent.image %}
                                                     src="/media/{{ student_parent.image }}"
                                                     {% else %}
                                                     src="{% static 'admin_dashboard/images/default_image.jpg' %}"
                                                     {% endif %}
                                                     style="width:100px;height:100px;border-radius:5px;object-fit:cover;" />
                                            </div>

                                            <div class="col-md-8">
                                                <p id="parent_name_display" class="mb-2"><strong>{{student_parent|title}}</strong></p>
                                                <p id="parent_mobile_display" class="mb-2 text-muted">
                                                    <i class="mdi mdi-phone me-1"></i>
                                                    {% if student_parent.mobile %} {{student_parent.mobile}} {% else %} Mobile Not Provided {% endif %}
                                                </p>
                                                <p id="parent_email_display" class="mb-2 text-muted">
                                                    <i class="mdi mdi-email me-1"></i>
                                                    {% if student_parent.email %} {{student_parent.email}} {% else %} Email Not Provided {% endif %}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Parent Change Section -->
                                        <div class="col-md-12 mt-4">
                                            <div class="card border">
                                                <div class="card-body">
                                                    <h5 class="card-title mb-1">Change Parent</h5>
                                                    <p class="text-muted small mb-3">Search and assign a different parent to this student</p>

                                                    <input type="hidden" id="parent_list" value="{{ parent_list }}">
                                                    <input type="hidden" id="original_parent_id" value="{{ original_parent_id }}">
                                                    <input type="hidden" id="current_selected_parent_id" value="{{ student_parent.id }}">
                                                    <input type="hidden" id="parent_changed" value="false">

                                                    <div class="form-group">
                                                        <label class="form-label">Search Parent by Name</label>
                                                        <div class="input-group">
                                                            <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
                                                            <input type="text" class="form-control" id="parent_search"
                                                                   placeholder="Type surname, middle name or last name...">
                                                        </div>
                                                        <small class="form-text text-muted">Start typing to see results (minimum 3 characters)</small>
                                                    </div>

                                                    <div class="row mt-3">
                                                        <div class="col-md-12">
                                                            <div id="parent_search_results" class="list-group" style="max-height: 300px; overflow-y: auto;"></div>
                                                        </div>
                                                    </div>

                                                    <div id="parent_detail_div" class="mt-3" style="display:none;">
                                                        <hr>
                                                        <div class="alert alert-info" role="alert">
                                                            <h6 class="alert-heading mb-3">
                                                                <i class="mdi mdi-information-outline me-1"></i>
                                                                New Parent Selected
                                                            </h6>
                                                            <div class="row">
                                                                <div class="col-md-3 text-center">
                                                                    <div id="new_parent_image"></div>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <div id="new_parent_fullname" class="mb-2"></div>
                                                                    <div id="new_parent_mobile" class="mb-2"></div>
                                                                    <div id="new_parent_email" class="mb-2"></div>
                                                                    <div id="new_parent_address" class="mb-3"></div>
                                                                    <div class="btn-group" role="group">
                                                                        <button type="button" id="confirm_parent_change" class="btn btn-success btn-sm">
                                                                            <i class="mdi mdi-check me-1"></i>Confirm Change
                                                                        </button>
                                                                        <button type="button" id="cancel_parent_change" class="btn btn-secondary btn-sm">
                                                                            <i class="mdi mdi-close me-1"></i>Cancel
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div id="parent_change_notice" class="alert alert-warning mt-3" style="display:none;">
                                                        <i class="mdi mdi-alert me-1"></i>
                                                        <strong>Parent Changed!</strong> Remember to save the form to apply all changes.
                                                        <button type="button" id="revert_parent_change" class="btn btn-warning btn-sm float-end">
                                                            <i class="mdi mdi-undo me-1"></i>Revert to Original
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <p class="card-title"> OTHER INFORMATION </p>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Relationship with student<span style="font-size:20px;color:red">*</span></label>
                                            <div class="col-sm-8">
                                                {{form.relationship_with_parent}}
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label"> Class<span style="font-size:20px;color:red">*</span></label>
                                            <div class="col-sm-8">
                                                <select name="student_class" class="form-control" id="id_student_class" required>
                                                    <option value="">----------</option>
                                                    {% for class in class_list %}
                                                    <option value="{{class.id}}" {% if class == student.student_class %} selected {% endif %} section="<option value=''>----------</option>
                                                    {% for section in class.section.all %}
                                                    <option value='{{section.id}}'>{{section.name|upper}}</option>
                                                    {% endfor %}
                                                    ">
                                                        {{class.name|upper}}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Class Section<span style="font-size:20px;color:red">*</span></label>
                                            <div class="col-sm-8">
                                                <select name="class_section" class="form-control" id="id_class_section" required>
                                                    {% for class in class_list %}
                                                        {% if class == student.student_class %}
                                                            {% for section in class.section.all %}
                                                                <option value="{{section.id}}" {% if section == student.class_section %} selected {% endif %}>{{ section }}</option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-4 col-form-label">Subject Group<span style="font-size:20px;color:red"></span></label>
                                            <div class="col-sm-8">
                                                {{ form.subject_group }}
                                            </div>
                                            <label class="col-sm-4 col-form-label">New Student<span style="font-size:20px;color:red"></span></label>
                                            <div class="col-sm-8 pt-2">
                                                {{ form.is_new }}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" name="updated_by" value="{{ user.id }}" />
                                <input type="hidden" name="type" value="{{ user.profile.type }}" />
                                <input type="hidden" name="group" value="{{ student.group.id }}" />
                                <input type="hidden" name="parent" id="parent_id_field" value="{{ student.parent.id }}" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Surname <span style="font-size:20px;color:red">*</span></label>
                                <div class="col-sm-8">
                                    {{form.surname}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Middle Name</label>
                                <div class="col-sm-8">
                                    {{form.middle_name}}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Last Name <span style="font-size:20px;color:red">*</span></label>
                                <div class="col-sm-8">
                                    {{form.last_name}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Reg No</label>
                                <div class="col-sm-8">
                                    <input type="text" name="registration_number" class="form-control" value="{{student.registration_number}}"
                                           {% if student_setting.auto_generate_student_id %} readonly {% else %} required {% endif %}>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Class Number <span style="font-size:20px;color:red">*</span></label>
                                <div class="col-sm-8">
                                    {{form.class_number}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Gender <span style="font-size:20px;color:red">*</span></label>
                                <div class="col-sm-8">
                                    {{form.gender}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Date of Birth</label>
                                <div class="col-sm-8">
                                    {{form.date_of_birth}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Photo</label>
                                <div class="col-sm-8">
                                    {{form.image}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Age</label>
                                <div class="col-sm-8">
                                    <br>{{form.age}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Utilities</label>
                                <div class="col-sm-8">
                                    <br>{{form.utilities}}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label">Status</label>
                                <div class="col-sm-8">
                                    <br>
                                    <select class='form-control' name='status' required>
                                        <option value='active' {% if student.status|lower == 'active' %} selected {% endif %}> Active </option>
                                        <option value='inactive' {% if student.status|lower == 'inactive' %} selected {% endif %}> Inactive </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                    <b>MORE INFORMATION</b>
                                </button>
                            </h2>
                        </div>

                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-3 col-form-label">State</label>
                                            <div class="col-sm-8">
                                                <select class="form-control" id="state" name="state">
                                                  <option value="">-----------------</option>
                                                  {% for state, lga_list in state_list.items %}
                                                  <option value="{{state|lower}}" {% if state|lower == student.state|lower %} selected {% endif %} lga="<option value=''>----------</option>
                                                  {% for lga in lga_list %}
                                                  <option value='{{lga|lower}}'>{{lga|upper}}</option>
                                                  {% endfor %}
                                                  ">
                                                  {{state|upper}}</option>
                                                  {% endfor %}
                                                </select>
                                                <br />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-3 col-form-label">Lga</label>
                                            <div class="col-sm-8">
                                                <select name="lga" class="form-control" id="lga">
                                                    {% if student.state %}
                                                        <option value="">----- select lga -----</option>
                                                        {% for state, lga_list in state_list.items %}
                                                            {% if state|lower == student.state|lower %}
                                                                {% for lga in lga_list %}
                                                                <option value="{{lga|lower}}" {% if lga|lower == student.lga|lower %} selected {% endif %}>{{ lga|upper }}</option>
                                                                {% endfor %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                    <option value="">----------</option>
                                                    {% endif %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-3 col-form-label">Religion</label>
                                            <div class="col-sm-8">
                                                {{form.religion}}
                                                <br />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-3 col-form-label">Email</label>
                                            <div class="col-sm-8">
                                                {{form.email}}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group row">
                                            <label class="col-sm-3 col-form-label">Phone No</label>
                                            <div class="col-sm-8">
                                                {{form.mobile}}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseTwo">
                                <b>HEALTH INFORMATION</b>
                            </button>
                        </h2>
                    </div>

                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Genotype</label>
                                        <div class="col-sm-8">
                                            {{form.genotype}}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group row">
                                        <label class="col-sm-4 col-form-label">Blood Group</label>
                                        <div class="col-sm-8">
                                            {{form.blood_group}}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-group row">
                                        <label class="col-sm-3 col-form-label">Health Note</label>
                                        <div class="col-sm-9">
                                            <textarea name="health_issue" class="form-control" style="margin-top:20px">{% if student.health_issue %} {{ student.health_issue }} {% endif %}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group row"></div>
                        </div>
                        <div class="col-md-6 text-center">
                            <br />
                            <button style="width:150px;margin:10px" class="btn btn-primary btn-rounded">Save Details</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'admin_dashboard/scripts/jquery.js' %}"></script>
<script>
$(document).ready(function(){
    // Class and section change
    $('#id_student_class').change(function(){
        section = $('option:selected', this).attr('section');
        $('#id_class_section').html(section);
    });

    $('#state').change(function(){
        lga = $('option:selected', this).attr('lga');
        $('#lga').html(lga);
    });

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = $('#toast');
        const toastMessage = $('#toast-message');

        // Set message
        toastMessage.text(message);

        // Set color based on type
        toast.removeClass('bg-success bg-warning bg-danger bg-info');
        if(type === 'success') {
            toast.addClass('bg-success text-white');
        } else if(type === 'warning') {
            toast.addClass('bg-warning text-dark');
        } else if(type === 'danger') {
            toast.addClass('bg-danger text-white');
        } else if(type === 'info') {
            toast.addClass('bg-info text-white');
        }

        // Show toast
        const bsToast = new bootstrap.Toast(toast[0], {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
    }

    // Store original parent data
    let originalParentData = {
        id: $('#original_parent_id').val(),
        image: "{% if student_parent.image %}{{ student_parent.image.url }}{% else %}{% static 'admin_dashboard/images/default_image.jpg' %}{% endif %}",
        fullname: "{{ student_parent|title }}",
        mobile: "{% if student_parent.mobile %}{{ student_parent.mobile }}{% else %}Mobile Not Provided{% endif %}",
        email: "{% if student_parent.email %}{{ student_parent.email }}{% else %}Email Not Provided{% endif %}"
    };

    // Function to update parent display
    function updateParentDisplay(parentData) {
        $('#parent_image_display').attr('src', parentData.image);
        $('#parent_name_display').html('<strong>' + parentData.fullname + '</strong>');
        $('#parent_mobile_display').html('<i class="mdi mdi-phone me-1"></i>' + parentData.mobile);
        $('#parent_email_display').html('<i class="mdi mdi-email me-1"></i>' + parentData.email);
    }

    // Parent search functionality
    $('#parent_search').on('input', function(){
        let search = $(this).val().toLowerCase().trim();
        let parent_list = JSON.parse($('#parent_list').val());
        $('#parent_search_results').empty();

        if(search.length >= 3) {
            let resultsFound = false;

            parent_list.forEach(function(parent){
                let fullname = (parent.fields.surname + ' ' + (parent.fields.middle_name || '') + ' ' + parent.fields.last_name).toLowerCase();

                if(fullname.includes(search)){
                    resultsFound = true;
                    let displayName = `${parent.fields.title || ''} ${parent.fields.surname} ${parent.fields.middle_name || ''} ${parent.fields.last_name}`.trim();
                    let mobile = parent.fields.mobile || 'No mobile';
                    let email = parent.fields.email || 'No email';

                    $('#parent_search_results').append(
                        `<a href="#" class="list-group-item list-group-item-action parent_item"
                            data-id="${parent.pk}"
                            data-image="${parent.fields.image || ''}"
                            data-fullname="${displayName}"
                            data-mobile="${parent.fields.mobile || 'Not Provided'}"
                            data-email="${parent.fields.email || 'Not Provided'}"
                            data-address="${parent.fields.residential_address || 'Not Provided'}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${displayName}</h6>
                            </div>
                            <small class="text-muted">
                                <i class="mdi mdi-phone me-1"></i>${mobile} |
                                <i class="mdi mdi-email me-1"></i>${email}
                            </small>
                        </a>`
                    );
                }
            });

            if(!resultsFound) {
                $('#parent_search_results').html(
                    '<div class="list-group-item text-muted">No parents found matching your search</div>'
                );
            }
        } else if(search.length > 0 && search.length < 3) {
            $('#parent_search_results').html(
                '<div class="list-group-item text-muted">Type at least 3 characters to search</div>'
            );
        }
    });

    // Handle parent selection
    $(document).on('click', '.parent_item', function(e){
        e.preventDefault();

        let parentId = $(this).data('id');
        let parentImage = $(this).data('image');
        let imageSrc = parentImage ? '/media/' + parentImage : "{% static 'admin_dashboard/images/default_image.jpg' %}";

        $('#new_parent_image').html(`<img src="${imageSrc}" style="width:80px;height:80px;border-radius:5px;object-fit:cover;" />`);
        $('#new_parent_fullname').html(`<strong><i class="mdi mdi-account me-1"></i>${$(this).data('fullname')}</strong>`);
        $('#new_parent_mobile').html(`<i class="mdi mdi-phone me-1"></i><strong>Mobile:</strong> ${$(this).data('mobile')}`);
        $('#new_parent_email').html(`<i class="mdi mdi-email me-1"></i><strong>Email:</strong> ${$(this).data('email')}`);
        $('#new_parent_address').html(`<i class="mdi mdi-map-marker me-1"></i><strong>Address:</strong> ${$(this).data('address')}`);

        $('#current_selected_parent_id').val(parentId);
        $('#parent_detail_div').show();
        $('#parent_search_results').empty();
        $('#parent_search').val('');

        showToast('Parent selected. Review and confirm the change.', 'info');
    });

    // Confirm parent change
    $('#confirm_parent_change').click(function(){
        let newParentId = $('#current_selected_parent_id').val();
        let newParentData = {
            id: newParentId,
            image: $('#new_parent_image img').attr('src'),
            fullname: $('#new_parent_fullname').text().replace('ðŸ‘¤', '').trim(),
            mobile: $('#new_parent_mobile').text().replace('Mobile:', '').trim(),
            email: $('#new_parent_email').text().replace('Email:', '').trim()
        };

        // Update the hidden field
        $('#parent_id_field').val(newParentId);

        // Update the display
        updateParentDisplay(newParentData);

        // Show success notice
        $('#parent_detail_div').hide();
        $('#parent_change_notice').show();
        $('#parent_changed').val('true');

        showToast('Parent changed successfully! Remember to save the form.', 'success');
    });

    // Cancel parent selection
    $('#cancel_parent_change').click(function(){
        $('#parent_detail_div').hide();
        $('#parent_search').val('');
        showToast('Parent selection cancelled', 'info');
    });

    // Revert to original parent
    $('#revert_parent_change').click(function(){
        $('#parent_id_field').val(originalParentData.id);
        $('#current_selected_parent_id').val(originalParentData.id);

        // Update display back to original
        updateParentDisplay(originalParentData);

        // Hide notices
        $('#parent_change_notice').hide();
        $('#parent_detail_div').hide();
        $('#parent_changed').val('false');

        showToast('Reverted to original parent', 'warning');
    });
});
</script>

<style>
#parent_search_results {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

#parent_search_results:empty {
    border: none;
}

.parent_item:hover {
    background-color: #f8f9fa;
}

.list-group-item-action {
    cursor: pointer;
}

#toast {
    min-width: 300px;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.card.border {
    border-color: #dee2e6 !important;
}
</style>

{% endblock %}